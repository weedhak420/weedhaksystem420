{% extends 'base.html' %}
{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
  <h1 class="h2">แก้ไขสินค้า</h1>
  <div class="btn-toolbar mb-2 mb-md-0">
      <a href="{{ url_for('main.products') }}" class="btn btn-sm btn-outline-secondary"><i class="bi bi-arrow-left me-2"></i>กลับไปยังรายการสินค้า</a>
      <a href="{{ url_for('main.inventory') }}" class="btn btn-primary btn-sm me-2"><i class="bi bi-arrow-left me-2"></i>กลับไปยังสต๊อก</a>
  </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay d-none">
    <div class="loading-content">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
        <div class="mt-3">
            <h5 class="text-primary">กำลังบันทึกข้อมูล...</h5>
            <p class="text-muted mb-2">กรุณารอสักครู่ ระบบกำลังอัปเดตข้อมูลสินค้า</p>
            <div class="progress" style="height: 6px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
            </div>
            <small class="text-muted mt-2 d-block">
                <i class="bi bi-cloud-upload me-1"></i>
                <span id="loadingStatus">กำลังซิงค์ข้อมูลกับ Google Sheets...</span>
            </small>
        </div>
    </div>
</div>

<div class="card">
  <div class="card-body">
      <form method="POST" enctype="multipart/form-data" id="editProductForm">
          <!-- CSRF Token - Multiple methods for compatibility -->
          <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token else '' }}"/>
          {% if request.csrf_token %}
          <input type="hidden" name="csrf_token" value="{{ request.csrf_token }}"/>
          {% endif %}
          
          <div class="row mb-3">
              <div class="col-md-6">
                  <label for="name" class="form-label">ชื่อสินค้า</label>
                  <input type="text" class="form-control" id="name" name="name" value="{{ product.name }}" required>
              </div>
              <div class="col-md-6">
                  <label for="flavor" class="form-label">รสชาติ</label>
                  <input type="text" class="form-control" id="flavor" name="flavor" value="{{ product.flavor }}" required>
              </div>
          </div>
          <div class="mb-3">
              <label for="description" class="form-label">รายละเอียด</label>
              <textarea class="form-control" id="description" name="description" rows="3">{{ product.description or '' }}</textarea>
          </div>
          <div class="row mb-3">
              <div class="col-md-3">
                  <label for="price" class="form-label">ราคาขาย (บาท)</label>
                  <input type="number" class="form-control" id="price" name="price" value="{{ product.price }}" min="0" step="0.01" required>
              </div>
              <div class="col-md-3">
                  <label for="cost" class="form-label">ต้นทุน (บาท)</label>
                  <input type="number" class="form-control" id="cost" name="cost" value="{{ product.cost }}" min="0" step="0.01" required>
              </div>
              <div class="col-md-3">
                  <label for="wholesale_price" class="form-label">ราคาขายส่ง (บาท)</label>
                  <input type="number" class="form-control" id="wholesale_price" name="wholesale_price" value="{{ product.wholesale_price or '' }}" min="0" step="0.01">
              </div>
              <div class="col-md-3">
                  <label for="stock" class="form-label">จำนวนในสต็อก</label>
                  <input type="number" class="form-control" id="stock" name="stock" value="{{ product.stock }}" min="0" required>
              </div>
          </div>
          <div class="row mb-3">
              <div class="col-md-4">
                  <label for="profit" class="form-label">กำไรต่อชิ้น</label>
                  <input type="text" class="form-control" id="profit" readonly value="{{ product.price - product.cost }}">
              </div>
              <div class="col-md-4">
                  <label for="profit_percentage" class="form-label">เปอร์เซ็นต์กำไร</label>
                  <input type="text" class="form-control" id="profit_percentage" readonly value="{{ '{:.2f}'.format(product.profit_margin) }}%">
              </div>
              <div class="col-md-4">
                  <label for="wholesale_profit" class="form-label">กำไรขายส่ง</label>
                  <input type="text" class="form-control" id="wholesale_profit" readonly value="{{ product.wholesale_price - product.cost if product.wholesale_price else '' }}">
              </div>
          </div>
          <div class="mb-3">
              <label for="barcode" class="form-label">บาร์โค้ด</label>
              <input type="text" class="form-control" id="barcode" name="barcode" value="{{ product.barcode or '' }}" placeholder="ป้อนบาร์โค้ดสินค้า (ถ้ามี)">
          </div>
          <div class="mb-3">
              <label for="image" class="form-label">รูปภาพสินค้า</label>
              {% if product.image_path %}
              <div class="mb-2">
                  <img src="{{ url_for('static', filename=product.image_path.replace('\\', '/')) }}" class="img-thumbnail" style="max-width: 200px;" alt="{{ product.name }} {{ product.flavor }}"
                       onerror="this.onerror=null; this.src='data:image/svg+xml;charset=UTF-8,%3Csvg width=\'200\' height=\'200\' xmlns=\'http://www.w3.org/2000/svg\' role=\'img\' aria-label=\'Placeholder\' preserveAspectRatio=\'xMidYMid slice\' focusable=\'false\'%3E%3Crect width=\'100%\' height=\'100%\' fill=\'%236c757d\'/%3E%3Ctext x=\'50%\' y=\'50%\' fill=\'%23dee2e6\' dy=\'.3em\' text-anchor=\'middle\'%3E{{ product.name }} {{ product.flavor }}%3C/text%3E%3C/svg%3E';">
              </div>
              {% endif %}
              <input type="file" class="form-control" id="image" name="image" accept="image/jpeg,image/png,image/gif,image/webp">
              <div class="form-text">อัปโหลดรูปภาพใหม่เพื่อแทนที่ (ไม่จำเป็น, รองรับ JPG, PNG, GIF, WEBP)</div>
              <div id="image-preview" class="mt-2 d-none">
                  <p>ตัวอย่างรูปภาพใหม่:</p>
                  <img id="preview-img" src="#" alt="ตัวอย่างรูปภาพ" class="img-thumbnail" style="max-width: 200px;">
              </div>
              <div id="upload-error" class="alert alert-danger mt-2 d-none">
                  เกิดข้อผิดพลาดในการอัปโหลดรูปภาพ กรุณาตรวจสอบขนาดและประเภทของไฟล์
              </div>
          </div>
          <div class="d-flex gap-2">
              <button type="submit" class="btn btn-primary" id="saveButton">
                  <i class="bi bi-check-circle me-2"></i>
                  <span id="saveButtonText">บันทึกการเปลี่ยนแปลง</span>
              </button>
              <button type="button" class="btn btn-secondary" onclick="window.history.back()">
                  <i class="bi bi-x-circle me-2"></i>ยกเลิก
              </button>
          </div>
      </form>
  </div>
</div>

<style>
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(5px);
    z-index: 9999;
    display: flex;
    justify-content: center;
    align-items: center;
}

.loading-content {
    text-align: center;
    background: white;
    padding: 2rem;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    border: 1px solid #e9ecef;
    max-width: 400px;
    width: 90%;
}

.loading-content .spinner-border {
    margin-bottom: 1rem;
}

.loading-content .progress {
    margin-top: 1rem;
    background-color: #f8f9fa;
}

.loading-content .progress-bar {
    background: linear-gradient(45deg, #007bff, #0056b3);
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.form-control:disabled {
    background-color: #f8f9fa;
    opacity: 0.8;
}

/* Animation for loading status text */
@keyframes pulse {
    0% { opacity: 0.6; }
    50% { opacity: 1; }
    100% { opacity: 0.6; }
}

.loading-status-animate {
    animation: pulse 2s infinite;
}

/* Success animation */
@keyframes checkmark {
    0% { transform: scale(0); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
}

.success-checkmark {
    animation: checkmark 0.6s ease-in-out;
    color: #28a745;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get form elements
    const form = document.getElementById('editProductForm');
    const saveButton = document.getElementById('saveButton');
    const saveButtonText = document.getElementById('saveButtonText');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingStatus = document.getElementById('loadingStatus');
    const priceInput = document.getElementById('price');
    const costInput = document.getElementById('cost');
    const wholesalePriceInput = document.getElementById('wholesale_price');
    const profitInput = document.getElementById('profit');
    const profitPercentageInput = document.getElementById('profit_percentage');
    const wholesaleProfitInput = document.getElementById('wholesale_profit');
    
    // Add CSRF token dynamically if not present
    function ensureCSRFToken() {
        const existingToken = form.querySelector('input[name="csrf_token"]');
        if (!existingToken || !existingToken.value) {
            // Try to get CSRF token from meta tag or create one
            let csrfToken = '';
            const metaToken = document.querySelector('meta[name="csrf-token"]');
            if (metaToken) {
                csrfToken = metaToken.getAttribute('content');
            } else {
                // Generate a simple token (this should ideally come from server)
                csrfToken = 'csrf_' + Math.random().toString(36).substr(2, 9);
            }
            
            if (existingToken) {
                existingToken.value = csrfToken;
            } else {
                const tokenInput = document.createElement('input');
                tokenInput.type = 'hidden';
                tokenInput.name = 'csrf_token';
                tokenInput.value = csrfToken;
                form.insertBefore(tokenInput, form.firstChild);
            }
        }
    }
    
    // Loading status messages
    const statusMessages = [
        'กำลังตรวจสอบข้อมูล...',
        'กำลังบันทึกลงฐานข้อมูล...',
        'กำลังซิงค์ข้อมูลกับ Google Sheets...',
        'กำลังอัปเดตสต็อกสินค้า...',
        'กำลังสร้างการแจ้งเตือน...',
        'เกือบเสร็จแล้ว...'
    ];
    
    let statusIndex = 0;
    let statusInterval;
    
    // Function to calculate profit
    function calculateProfit() {
        const price = parseFloat(priceInput.value) || 0;
        const cost = parseFloat(costInput.value) || 0;
        const wholesalePrice = parseFloat(wholesalePriceInput.value) || 0;
        
        // Calculate profit per unit
        const profit = price - cost;
        profitInput.value = profit.toFixed(2);
        
        // Calculate profit percentage
        const profitPercentage = price > 0 ? (profit / price) * 100 : 0;
        profitPercentageInput.value = profitPercentage.toFixed(2) + '%';
        
        // Calculate wholesale profit
        if (wholesalePrice > 0) {
            const wholesaleProfit = wholesalePrice - cost;
            wholesaleProfitInput.value = wholesaleProfit.toFixed(2);
        } else {
            wholesaleProfitInput.value = '';
        }
    }
    
    // Add event listeners to inputs
    priceInput.addEventListener('input', calculateProfit);
    costInput.addEventListener('input', calculateProfit);
    wholesalePriceInput.addEventListener('input', calculateProfit);
    
    // Initial calculation
    calculateProfit();

    // Image preview functionality
    const imageInput = document.getElementById('image');
    const imagePreview = document.getElementById('image-preview');
    const previewImg = document.getElementById('preview-img');
    const uploadError = document.getElementById('upload-error');

    imageInput.addEventListener('change', function() {
        if (this.files && this.files[0]) {
            const file = this.files[0];
            // ตรวจสอบประเภทไฟล์
            if (!file.type.match('image/(jpeg|png|gif|webp)')) {
                uploadError.classList.remove('d-none');
                uploadError.textContent = 'กรุณาอัปโหลดไฟล์รูปภาพเท่านั้น (JPG, PNG, GIF, WEBP)';
                imagePreview.classList.add('d-none');
                this.value = ''; // Clear the input
                return;
            }
            
            // ตรวจสอบขนาดไฟล์ (ไม่เกิน 5MB)
            if (file.size > 5 * 1024 * 1024) {
                uploadError.classList.remove('d-none');
                uploadError.textContent = 'ขนาดไฟล์ต้องไม่เกิน 5MB';
                imagePreview.classList.add('d-none');
                this.value = ''; // Clear the input
                return;
            }
            
            uploadError.classList.add('d-none');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImg.src = e.target.result;
                imagePreview.classList.remove('d-none');
            }
            reader.readAsDataURL(file);
        }
    });
    
    // Function to show loading
    function showLoading() {
        loadingOverlay.classList.remove('d-none');
        saveButton.disabled = true;
        
        // Change button text and icon
        saveButtonText.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>กำลังบันทึก...';
        
        // Start status rotation
        statusIndex = 0;
        loadingStatus.textContent = statusMessages[statusIndex];
        loadingStatus.classList.add('loading-status-animate');
        
        statusInterval = setInterval(() => {
            statusIndex = (statusIndex + 1) % statusMessages.length;
            loadingStatus.textContent = statusMessages[statusIndex];
        }, 2000);
    }
    
    // Function to hide loading
    function hideLoading() {
        clearInterval(statusInterval);
        loadingStatus.classList.remove('loading-status-animate');
        
        // Show success message briefly
        loadingStatus.innerHTML = '<i class="bi bi-check-circle success-checkmark me-1"></i>บันทึกสำเร็จ!';
        
        setTimeout(() => {
            loadingOverlay.classList.add('d-none');
            
            saveButton.disabled = false;
            saveButtonText.innerHTML = '<i class="bi bi-check-circle me-2"></i>บันทึกการเปลี่ยนแปลง';
        }, 1500);
    }
    
    // Prevent multiple form submissions
    let isSubmitting = false;
    
    // Form submission handler
    form.addEventListener('submit', function(e) {
        if (isSubmitting) {
            e.preventDefault();
            return false;
        }
        
        // Ensure CSRF token is present
        ensureCSRFToken();
        
        // Show loading immediately
        showLoading();
        isSubmitting = true;
        
        // Let the form submit normally
        // The loading will be hidden when the page redirects or reloads
        
        // If there's an error and the page doesn't redirect, hide loading after timeout
        setTimeout(() => {
            if (!loadingOverlay.classList.contains('d-none')) {
                hideLoading();
                isSubmitting = false;
            }
        }, 30000); // 30 seconds timeout
    });
    
    // Handle page visibility change (when user comes back to tab)
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden && !loadingOverlay.classList.contains('d-none')) {
            // If page becomes visible and loading is still showing, hide it
            setTimeout(() => {
                if (!loadingOverlay.classList.contains('d-none')) {
                    hideLoading();
                    isSubmitting = false;
                }
            }, 1000);
        }
    });
    
    // Handle browser back/forward buttons
    window.addEventListener('pageshow', function(event) {
        if (event.persisted) {
            // Page was loaded from cache, hide loading
            loadingOverlay.classList.add('d-none');
            saveButton.disabled = false;
            saveButtonText.innerHTML = '<i class="bi bi-check-circle me-2"></i>บันทึกการเปลี่ยนแปลง';
            isSubmitting = false;
        }
    });
    
    // Auto-save draft functionality (optional)
    let autoSaveTimeout;
    const formInputs = form.querySelectorAll('input[type="text"], input[type="number"], textarea');
    
    formInputs.forEach(input => {
        input.addEventListener('input', function() {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(() => {
                // Save to localStorage as draft
                const formData = new FormData(form);
                const draftData = {};
                for (let [key, value] of formData.entries()) {
                    if (key !== 'csrf_token' && key !== 'image') {
                        draftData[key] = value;
                    }
                }
                localStorage.setItem('edit_product_draft_{{ product.id }}', JSON.stringify(draftData));
            }, 2000);
        });
    });
    
    // Load draft data on page load
    const draftKey = 'edit_product_draft_{{ product.id }}';
    const savedDraft = localStorage.getItem(draftKey);
    if (savedDraft) {
        try {
            const draftData = JSON.parse(savedDraft);
            // Show notification about draft
            const draftNotification = document.createElement('div');
            draftNotification.className = 'alert alert-info alert-dismissible fade show';
            draftNotification.innerHTML = `
                <i class="bi bi-info-circle me-2"></i>
                พบข้อมูลที่บันทึกไว้ล่าสุด คุณต้องการกู้คืนข้อมูลหรือไม่?
                <button type="button" class="btn btn-sm btn-outline-primary ms-2" onclick="restoreDraft()">กู้คืน</button>
                <button type="button" class="btn btn-sm btn-outline-secondary ms-1" onclick="clearDraft()">ลบ</button>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            form.insertBefore(draftNotification, form.firstChild);
            
            // Make restore and clear functions global
            window.restoreDraft = function() {
                Object.keys(draftData).forEach(key => {
                    const input = form.querySelector(`[name="${key}"]`);
                    if (input) {
                        input.value = draftData[key];
                    }
                });
                calculateProfit();
                draftNotification.remove();
            };
            
            window.clearDraft = function() {
                localStorage.removeItem(draftKey);
                draftNotification.remove();
            };
        } catch (e) {
            localStorage.removeItem(draftKey);
        }
    }
    
    // Clear draft on successful submission
    form.addEventListener('submit', function() {
        setTimeout(() => {
            localStorage.removeItem(draftKey);
        }, 1000);
    });
});
</script>
{% endblock %}
