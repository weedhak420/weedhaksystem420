{% extends 'base.html' %}
{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
  <h1 class="h2">บันทึกกิจกรรมผู้ใช้</h1>
  <div class="btn-toolbar mb-2 mb-md-0">
      <a href="{{ url_for('main.dashboard') }}" class="btn btn-sm btn-outline-secondary"><i class="bi bi-arrow-left me-2"></i>กลับไปยังแดชบอร์ด</a>
  </div>
</div>

<div class="card mb-4">
  <div class="card-header">
    <h5 class="mb-0">ตัวกรองข้อมูล</h5>
  </div>
  <div class="card-body">
    <form id="filter-form" class="row g-3">
      <div class="col-md-3">
        <label for="user_filter" class="form-label">ผู้ใช้</label>
        <select class="form-select" id="user_filter">
          <option value="">ทั้งหมด</option>
          {% for user in users %}
          <option value="{{ user.id }}">{{ user.username }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <label for="action_filter" class="form-label">ประเภทกิจกรรม</label>
        <select class="form-select" id="action_filter">
          <option value="">ทั้งหมด</option>
          <option value="login">เข้าสู่ระบบ</option>
          <option value="logout">ออกจากระบบ</option>
          <option value="add_product">เพิ่มสินค้า</option>
          <option value="edit_product">แก้ไขสินค้า</option>
          <option value="delete_product">ลบสินค้า</option>
          <option value="add_order">เพิ่มคำสั่งซื้อ</option>
          <option value="add_inventory">เพิ่มสต็อก</option>
          <!-- เพิ่มประเภทกิจกรรมอื่นๆ ตามที่มีในระบบ -->
        </select>
      </div>
      <div class="col-md-3">
        <label for="date_from" class="form-label">ตั้งแต่วันที่</label>
        <input type="date" class="form-control" id="date_from">
      </div>
      <div class="col-md-3">
        <label for="date_to" class="form-label">ถึงวันที่</label>
        <input type="date" class="form-control" id="date_to">
      </div>
      <div class="col-12">
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-filter me-2"></i>กรองข้อมูล
        </button>
        <button type="button" id="reset-filter" class="btn btn-outline-secondary">
          <i class="bi bi-x-circle me-2"></i>ล้างตัวกรอง
        </button>
      </div>
    </form>
  </div>
</div>

<div class="card">
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-striped table-sm">
        <thead>
          <tr>
            <th>เวลา</th>
            <th>ผู้ใช้</th>
            <th>กิจกรรม</th>
            <th>ประเภท</th>
            <th>รายละเอียด</th>
            <th>IP Address</th>
          </tr>
        </thead>
        <tbody id="logs-table-body">
          <tr>
            <td colspan="6" class="text-center">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">กำลังโหลด...</span>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <nav aria-label="Page navigation" class="mt-4">
      <ul class="pagination justify-content-center" id="pagination">
        <!-- Pagination will be generated by JavaScript -->
      </ul>
    </nav>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  let currentPage = 1;
  
  // Load logs on page load
  loadLogs();
  
  // Handle filter form submission
  document.getElementById('filter-form').addEventListener('submit', function(e) {
    e.preventDefault();
    currentPage = 1;
    loadLogs();
  });
  
  // Handle reset filter button
  document.getElementById('reset-filter').addEventListener('click', function() {
    document.getElementById('user_filter').value = '';
    document.getElementById('action_filter').value = '';
    document.getElementById('date_from').value = '';
    document.getElementById('date_to').value = '';
    currentPage = 1;
    loadLogs();
  });
  
  // Function to load logs from API
  function loadLogs() {
    const userFilter = document.getElementById('user_filter').value;
    const actionFilter = document.getElementById('action_filter').value;
    const dateFrom = document.getElementById('date_from').value;
    const dateTo = document.getElementById('date_to').value;
    
    // Build query string
    let queryParams = `page=${currentPage}`;
    if (userFilter) queryParams += `&user_id=${userFilter}`;
    if (actionFilter) queryParams += `&action_type=${actionFilter}`;
    if (dateFrom) queryParams += `&date_from=${dateFrom}`;
    if (dateTo) queryParams += `&date_to=${dateTo}`;
    
    // Show loading state
    document.getElementById('logs-table-body').innerHTML = `
      <tr>
        <td colspan="6" class="text-center">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">กำลังโหลด...</span>
          </div>
        </td>
      </tr>
    `;
    
    // Fetch data from API
    fetch(`/api/activity_logs?${queryParams}`)
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(data => {
        // Update table with logs
        updateLogsTable(data.logs);
        
        // Update pagination
        updatePagination(data.current_page, data.pages);
      })
      .catch(error => {
        console.error('Error fetching logs:', error);
        document.getElementById('logs-table-body').innerHTML = `
          <tr>
            <td colspan="6" class="text-center text-danger">
              <i class="bi bi-exclamation-triangle me-2"></i>เกิดข้อผิดพลาดในการโหลดข้อมูล
            </td>
          </tr>
        `;
      });
  }
  
  // Function to update logs table
  function updateLogsTable(logs) {
    const tableBody = document.getElementById('logs-table-body');
    
    if (logs.length === 0) {
      tableBody.innerHTML = `
        <tr>
          <td colspan="6" class="text-center">ไม่มีบันทึกกิจกรรม</td>
        </tr>
      `;
      return;
    }
    
    let html = '';
    logs.forEach(log => {
      html += `
        <tr>
          <td>${log.timestamp}</td>
          <td>${log.user || '-'}</td>
          <td>${log.action}</td>
          <td>${log.entity_type || '-'}</td>
          <td>${log.details || '-'}</td>
          <td>${log.ip_address}</td>
        </tr>
      `;
    });
    
    tableBody.innerHTML = html;
  }
  
  // Function to update pagination
  function updatePagination(currentPage, totalPages) {
    const pagination = document.getElementById('pagination');
    
    if (totalPages <= 1) {
      pagination.innerHTML = '';
      return;
    }
    
    let html = '';
    
    // Previous button
    html += `
      <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
        <a class="page-link" href="#" data-page="${currentPage - 1}" aria-label="Previous">
          <span aria-hidden="true">&laquo;</span>
        </a>
      </li>
    `;
    
    // Page numbers
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, startPage + 4);
    
    for (let i = startPage; i <= endPage; i++) {
      html += `
        <li class="page-item ${i === currentPage ? 'active' : ''}">
          <a class="page-link" href="#" data-page="${i}">${i}</a>
        </li>
      `;
    }
    
    // Next button
    html += `
      <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
        <a class="page-link" href="#" data-page="${currentPage + 1}" aria-label="Next">
          <span aria-hidden="true">&raquo;</span>
        </a>
      </li>
    `;
    
    pagination.innerHTML = html;
    
    // Add event listeners to pagination links
    document.querySelectorAll('.page-link').forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        const page = parseInt(this.getAttribute('data-page'));
        if (page && page !== currentPage) {
          currentPage = page;
          loadLogs();
          // Scroll to top of table
          document.querySelector('.card').scrollIntoView({ behavior: 'smooth' });
        }
      });
    });
  }
});
</script>
{% endblock %}